{% extends 'layout.html' %}
{% block content %}
<div class="card admin-card">
  <div class="card-body">
    <h4 class="card-title">管理员</h4>
    {% if not is_admin %}
    <p>请输入管理员密码以进入管理界面。</p>
    <form method="post" action="/admin" class="row g-2 align-items-center">
      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
      <div class="col-auto">
        <input type="password" name="password" class="form-control" placeholder="管理员密码">
      </div>
      <div class="col-auto">
        <button class="btn btn-primary">登录</button>
      </div>
    </form>
    {% else %}
    <p>你已登录为管理员，可执行管理操作。</p>
    <div class="row">
      <div class="col-md-6">
        <h5 class="mt-3">新增设备</h5>
        <!-- Button trigger modal -->
        <button type="button" class="btn btn-success" data-bs-toggle="modal" data-bs-target="#addEquipModal">
          <i class="bi bi-plus-lg"></i> 添加设备
        </button>

        <!-- Modal -->
        <div class="modal fade" id="addEquipModal" tabindex="-1" aria-labelledby="addEquipModalLabel" aria-hidden="true">
          <div class="modal-dialog modal-sm modal-dialog-centered">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="addEquipModalLabel">新增设备</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <form method="post" action="/add_equipment" enctype="multipart/form-data">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                  <div class="mb-2">
                    <label class="form-label small">设备名</label>
                    <input type="text" name="name" class="form-control" placeholder="例如：篮球" required>
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">数量</label>
                    <input type="number" name="total" class="form-control" value="1" min="1">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">价格 (元)</label>
                    <input type="number" name="price" class="form-control" value="0" min="0" step="0.01">
                  </div>
                  <div class="mb-2">
                    <label class="form-label small">图片</label>
                    <input type="file" name="image" class="form-control">
                  </div>
                </div>
                <div class="modal-footer">
                  <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                  <button type="submit" class="btn btn-primary">确认添加</button>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>

    <h5 class="mt-4">待审核申请</h5>
    <div class="table-responsive mb-4">
      <table class="table table-sm align-middle">
        <thead class="table-light"><tr><th>申请人</th><th>设备</th><th>数量</th><th>申请时间</th><th>操作</th></tr></thead>
        <tbody>
          {% for r in pending_records %}
          <tr>
            <td>{{ r.user_name }}</td>
            <td>{{ r.equipment.name }}</td>
            <td>{{ r.quantity }}</td>
            <td>{{ r.borrow_date.strftime('%Y-%m-%d %H:%M') if r.borrow_date else 'Pending' }}</td>
            <td>
              <form method="post" action="/admin/approve_borrow/{{ r.id }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-success">通过</button>
              </form>
              <form method="post" action="/admin/reject_borrow/{{ r.id }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-danger">拒绝</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="5" class="text-muted text-center">无待审核申请</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h5 class="mt-4">待领取 (已审核)</h5>
    <div class="table-responsive mb-4">
      <table class="table table-sm align-middle">
        <thead class="table-light"><tr><th>申请人</th><th>设备</th><th>数量</th><th>操作</th></tr></thead>
        <tbody>
          {% for r in approved_records %}
          <tr>
            <td>{{ r.user_name }}</td>
            <td>{{ r.equipment.name }}</td>
            <td>{{ r.quantity }}</td>
            <td>
              <form method="post" action="/admin/confirm_pickup/{{ r.id }}" class="d-inline">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button class="btn btn-sm btn-primary">确认借出 (已领取)</button>
              </form>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="4" class="text-muted text-center">无待领取记录</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h5 class="mt-4">借出中 / 维修中</h5>
    <div class="table-responsive mb-4">
      <table class="table table-sm align-middle">
        <thead class="table-light"><tr><th>借用人</th><th>设备</th><th>数量</th><th>借出时间</th><th>应还时间</th><th>状态</th><th>操作</th></tr></thead>
        <tbody>
          {% for r in borrowed_records %}
          <tr>
            <td>{{ r.user_name }}</td>
            <td>{{ r.equipment.name }}</td>
            <td>{{ r.quantity }}</td>
            <td>{{ r.borrow_date.strftime('%Y-%m-%d %H:%M') if r.borrow_date else '' }}</td>
            <td>{{ r.due_date.strftime('%Y-%m-%d %H:%M') if r.due_date else '' }}</td>
            <td>
                {% if r.status == 'repair_pending' %}
                <span class="badge bg-warning text-dark">报修中</span>
                {% else %}
                <span class="badge bg-info text-dark">借出中</span>
                {% endif %}
            </td>
            <td>
              <!-- Return Modal Trigger -->
              <button type="button" class="btn btn-sm btn-outline-success" data-bs-toggle="modal" data-bs-target="#returnModal{{ r.id }}">
                归还
              </button>
              
              <!-- Return Modal -->
              <div class="modal fade" id="returnModal{{ r.id }}" tabindex="-1" aria-hidden="true">
                <div class="modal-dialog modal-sm">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h6 class="modal-title">归还确认</h6>
                      <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                    </div>
                    <form method="post" action="/return">
                      <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                      <input type="hidden" name="record_id" value="{{ r.id }}">
                      <div class="modal-body">
                        <p>确认归还 {{ r.equipment.name }} x {{ r.quantity }}?</p>
                        <div class="form-check">
                          <input class="form-check-input" type="checkbox" name="is_damaged" id="damaged{{ r.id }}">
                          <label class="form-check-label" for="damaged{{ r.id }}">
                            器材损坏 (赔偿 1.5 倍)
                          </label>
                        </div>
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-success btn-sm">确认归还</button>
                      </div>
                    </form>
                  </div>
                </div>
              </div>
            </td>
          </tr>
          {% else %}
          <tr><td colspan="7" class="text-muted text-center">无借出记录</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h5 class="mt-4">设备管理</h5>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light"><tr><th>名称</th><th>图片</th><th style="width:140px;">总量</th><th style="width:120px;">价格</th><th style="width:120px;">可借</th><th style="width:140px;">操作</th></tr></thead>
        <tbody>
          {% for e in equipments %}
          <tr id="e{{ e.id }}">
            <td>{{ e.name }}</td>
            <form method="post" action="/admin/edit_equipment/{{ e.id }}" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            <td>
                <input type="file" name="image" class="form-control form-control-sm" style="width: 150px;">
            </td>
            <td>
                <input type="number" name="total" class="form-control form-control-sm" value="{{ e.total_quantity }}" style="width:80px;">
            </td>
            <td>
                <input type="number" name="price" class="form-control form-control-sm" value="{{ e.price or 0 }}" style="width:80px;" step="0.01">
            </td>
            <td><span class="fw-bold">{{ e.available_quantity }}</span></td>
            <td>
                <button class="btn btn-sm btn-outline-primary"><i class="bi bi-save"></i> 保存</button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="if(confirm('确认删除？')) { document.getElementById('del{{ e.id }}').submit(); }"><i class="bi bi-trash"></i> 删除</button>
            </td>
            </form>
            <form id="del{{ e.id }}" method="post" action="/admin/delete_equipment/{{ e.id }}" style="display:none;">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
            </form>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
    <h5 class="mt-4">注册用户</h5>
    <form class="row g-2 mb-3" method="get" action="{{ url_for('admin') }}">
      <div class="col-auto">
        <input class="form-control form-control-sm" name="q" placeholder="搜索用户 名称/用户名/班级" value="{{ request.args.get('q','') }}">
      </div>
      <div class="col-auto">
        <button class="btn btn-sm btn-outline-primary">搜索</button>
      </div>
    </form>
    <div class="table-responsive">
      <table class="table table-sm align-middle">
        <thead class="table-light"><tr><th>用户名</th><th>姓名</th><th>班级</th><th>性别</th><th>电话</th><th>操作</th></tr></thead>
        <tbody>
          {% for u in users %}
          <tr>
            <td>{{ u.username }}</td>
            <td>{{ u.full_name or '-' }}</td>
            <td>{{ u.class_name or '-' }}</td>
            <td>{{ u.gender or '-' }}</td>
            <td>{{ u.phone or '-' }}</td>
            <td>
              <a class="btn btn-sm btn-outline-primary" href="{{ url_for('admin_view_user', user_id=u.id) }}">查看记录</a>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <h5 class="mt-4">资讯管理</h5>
    <div class="row g-3">
      <div class="col-lg-5">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">发布新资讯</h6>
            <form method="post" action="{{ url_for('create_news') }}" class="news-form">
              <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
              <div class="mb-2">
                <label class="form-label">标题</label>
                <input class="form-control" name="title" required>
              </div>
              <div class="mb-2">
                <label class="form-label">摘要</label>
                <textarea class="form-control" name="summary" rows="2" placeholder="不填则自动截取正文"></textarea>
              </div>
              <div class="mb-2">
                <label class="form-label">正文</label>
                <textarea class="form-control" name="content" rows="4" required></textarea>
              </div>
              <div class="row g-2">
                <div class="col-md-6">
                  <label class="form-label">分类</label>
                  <select class="form-select" name="category">
                    {% for key, label in news_categories.items() %}
                    <option value="{{ key }}">{{ label }}</option>
                    {% endfor %}
                  </select>
                </div>
                <div class="col-md-6">
                  <label class="form-label">发布时间</label>
                  <input class="form-control" type="datetime-local" name="published_at">
                </div>
              </div>
              <div class="mb-2 mt-2">
                <label class="form-label">来源（可空）</label>
                <input class="form-control" name="source" placeholder="例如：教育部官网">
              </div>
              <div class="form-check form-switch mb-3">
                <input class="form-check-input" type="checkbox" id="newsPinned" name="is_pinned">
                <label class="form-check-label" for="newsPinned">置顶显示</label>
              </div>
              <button class="btn btn-primary w-100" type="submit">发布资讯</button>
            </form>
          </div>
        </div>
      </div>
      <div class="col-lg-7">
        <div class="card h-100">
          <div class="card-body">
            <h6 class="card-title">已发布资讯</h6>
            {% if news_items %}
              <div class="news-admin-list">
                {% for article in news_items %}
                <details class="news-admin-item" id="news{{ article.id }}">
                  <summary>
                    <div>
                      <strong>{{ article.title }}</strong>
                      <span class="text-muted small ms-2">{{ article.published_at.strftime('%Y-%m-%d %H:%M') if article.published_at else '' }}</span>
                    </div>
                    <span class="badge bg-secondary">{{ news_categories.get(article.category, '资讯') }}</span>
                  </summary>
                  <form method="post" action="{{ url_for('edit_news', news_id=article.id) }}" class="mt-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <div class="mb-2">
                      <label class="form-label">标题</label>
                      <input class="form-control" name="title" value="{{ article.title }}">
                    </div>
                    <div class="mb-2">
                      <label class="form-label">摘要</label>
                      <textarea class="form-control" name="summary" rows="2">{{ article.summary }}</textarea>
                    </div>
                    <div class="mb-2">
                      <label class="form-label">正文</label>
                      <textarea class="form-control" name="content" rows="4">{{ article.content }}</textarea>
                    </div>
                    <div class="row g-2">
                      <div class="col-md-4">
                        <label class="form-label">分类</label>
                        <select class="form-select" name="category">
                          {% for key, label in news_categories.items() %}
                          <option value="{{ key }}" {% if article.category == key %}selected{% endif %}>{{ label }}</option>
                          {% endfor %}
                        </select>
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">发布时间</label>
                        <input class="form-control" type="datetime-local" name="published_at" value="{{ article.published_at.strftime('%Y-%m-%dT%H:%M') if article.published_at else '' }}">
                      </div>
                      <div class="col-md-4">
                        <label class="form-label">来源</label>
                        <input class="form-control" name="source" value="{{ article.source or '' }}">
                      </div>
                    </div>
                    <div class="form-check form-switch mt-2">
                      <input class="form-check-input" type="checkbox" id="pinned{{ article.id }}" name="is_pinned" {% if article.is_pinned %}checked{% endif %}>
                      <label class="form-check-label" for="pinned{{ article.id }}">置顶</label>
                    </div>
                    <div class="d-flex gap-2 mt-3">
                      <button class="btn btn-primary" type="submit">保存修改</button>
                    </div>
                  </form>
                  <form method="post" action="{{ url_for('delete_news', news_id=article.id) }}" onsubmit="return confirm('确认删除该资讯？');" class="mt-2">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button class="btn btn-outline-danger" type="submit">删除</button>
                  </form>
                </details>
                {% endfor %}
              </div>
            {% else %}
              <p class="text-muted">暂无资讯，使用左侧表单发布。</p>
            {% endif %}
          </div>
        </div>
      </div>
    </div>
    {% endif %}
  </div>
</div>

<!-- If an equipment was just added, highlight it and scroll into view -->
<script>
document.addEventListener('DOMContentLoaded', function(){
  try{
    const params = new URLSearchParams(window.location.search);
    const id = params.get('added_id');
    if(id){
      const row = document.getElementById('e' + id);
      if(row){
        row.classList.add('row-highlight');
        row.scrollIntoView({behavior: 'smooth', block: 'center'});
        setTimeout(()=> row.classList.remove('table-success'), 4000);
      }
    }
  }catch(e){/* ignore */}
});
</script>

{% endblock %}
